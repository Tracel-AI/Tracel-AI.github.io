<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Data - The Burn Book ðŸ”¥</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../motivation.html"><strong aria-hidden="true">2.</strong> Why Burn?</a></li><li class="chapter-item expanded "><a href="../getting-started.html"><strong aria-hidden="true">3.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../basic-workflow/index.html"><strong aria-hidden="true">4.</strong> Basic Workflow: From Training to Inference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basic-workflow/model.html"><strong aria-hidden="true">4.1.</strong> Model</a></li><li class="chapter-item expanded "><a href="../basic-workflow/data.html" class="active"><strong aria-hidden="true">4.2.</strong> Data</a></li><li class="chapter-item expanded "><a href="../basic-workflow/training.html"><strong aria-hidden="true">4.3.</strong> Training</a></li><li class="chapter-item expanded "><a href="../basic-workflow/backend.html"><strong aria-hidden="true">4.4.</strong> Backend</a></li><li class="chapter-item expanded "><a href="../basic-workflow/inference.html"><strong aria-hidden="true">4.5.</strong> Inference</a></li><li class="chapter-item expanded "><a href="../basic-workflow/conclusion.html"><strong aria-hidden="true">4.6.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="../building-blocks/index.html"><strong aria-hidden="true">5.</strong> Building Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building-blocks/backend.html"><strong aria-hidden="true">5.1.</strong> Backend</a></li><li class="chapter-item expanded "><a href="../building-blocks/tensor.html"><strong aria-hidden="true">5.2.</strong> Tensor</a></li><li class="chapter-item expanded "><a href="../building-blocks/autodiff.html"><strong aria-hidden="true">5.3.</strong> Autodiff</a></li><li class="chapter-item expanded "><a href="../building-blocks/module.html"><strong aria-hidden="true">5.4.</strong> Module</a></li><li class="chapter-item expanded "><a href="../building-blocks/learner.html"><strong aria-hidden="true">5.5.</strong> Learner</a></li><li class="chapter-item expanded "><a href="../building-blocks/metric.html"><strong aria-hidden="true">5.6.</strong> Metric</a></li><li class="chapter-item expanded "><a href="../building-blocks/config.html"><strong aria-hidden="true">5.7.</strong> Config</a></li><li class="chapter-item expanded "><a href="../building-blocks/record.html"><strong aria-hidden="true">5.8.</strong> Record</a></li><li class="chapter-item expanded "><a href="../building-blocks/dataset.html"><strong aria-hidden="true">5.9.</strong> Dataset</a></li></ol></li><li class="chapter-item expanded "><a href="../custom-training-loop.html"><strong aria-hidden="true">6.</strong> Custom Training Loop</a></li><li class="chapter-item expanded "><a href="../saving-and-loading.html"><strong aria-hidden="true">7.</strong> Saving & Loading Models</a></li><li class="chapter-item expanded "><a href="../import/index.html"><strong aria-hidden="true">8.</strong> Import Models</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../import/onnx-model.html"><strong aria-hidden="true">8.1.</strong> ONNX Model</a></li><li class="chapter-item expanded "><a href="../import/pytorch-model.html"><strong aria-hidden="true">8.2.</strong> PyTorch Model</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced/index.html"><strong aria-hidden="true">9.</strong> Advanced</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/backend-extension/index.html"><strong aria-hidden="true">9.1.</strong> Backend Extension</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/backend-extension/custom-wgpu-kernel.html"><strong aria-hidden="true">9.1.1.</strong> Custom WGPU Kernel</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.2.</strong> Custom Optimizer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.3.</strong> WebAssembly</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.4.</strong> No-Std</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Burn Book ðŸ”¥</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="data"><a class="header" href="#data">Data</a></h1>
<p>Typically, one trains a model on some dataset. Burn provides a library of very useful dataset
sources and transformations. In particular, there are Hugging Face dataset utilities that allow to
download and store data from Hugging Face into an SQLite database for extremely efficient data
streaming and storage. For this guide, we will use the MNIST dataset provided by Hugging Face.</p>
<p>To iterate over a dataset efficiently, we will define a struct which will implement the <code>Batcher</code>
trait. The goal of a batcher is to map individual dataset items into a batched tensor that can be
used as input to our previously defined model.</p>
<p>Let us start by defining our dataset functionalities in a file <code>src/data.rs</code>. We shall omit some of the imports for
brevity,
but the full code for following this guide can be found
at <code>examples/guide/</code> <a href="https://github.com/tracel-ai/burn/tree/main/examples/guide">directory</a>.</p>
<pre><code class="language-rust   ignore">use burn::{
    data::{dataloader::batcher::Batcher, dataset::vision::MNISTItem},
    tensor::{backend::Backend, Data, ElementConversion, Int, Tensor},
};

pub struct MNISTBatcher&lt;B: Backend&gt; {
    device: B::Device,
}

impl&lt;B: Backend&gt; MNISTBatcher&lt;B&gt; {
    pub fn new(device: B::Device) -&gt; Self {
        Self { device }
    }
}
</code></pre>
<p>This codeblock defines a batcher struct with the device in which the tensor should be sent before
being passed to the model. Note that the device is an associative type of the <code>Backend</code> trait since
not all backends expose the same devices. As an example, the Libtorch-based backend exposes
<code>Cuda(gpu_index)</code>, <code>Cpu</code>, <code>Vulkan</code> and <code>Metal</code> devices, while the ndarray backend only exposes the
<code>Cpu</code> device.</p>
<p>Next, we need to actually implement the batching logic.</p>
<pre><code class="language-rust   ignore">#[derive(Clone, Debug)]
pub struct MNISTBatch&lt;B: Backend&gt; {
    pub images: Tensor&lt;B, 3&gt;,
    pub targets: Tensor&lt;B, 1, Int&gt;,
}

impl&lt;B: Backend&gt; Batcher&lt;MNISTItem, MNISTBatch&lt;B&gt;&gt; for MNISTBatcher&lt;B&gt; {
    fn batch(&amp;self, items: Vec&lt;MNISTItem&gt;) -&gt; MNISTBatch&lt;B&gt; {
        let images = items
            .iter()
            .map(|item| Data::&lt;f32, 2&gt;::from(item.image))
            .map(|data| Tensor::&lt;B, 2&gt;::from_data(data.convert(), &amp;self.device))
            .map(|tensor| tensor.reshape([1, 28, 28]))
            // Normalize: make between [0,1] and make the mean=0 and std=1
            // values mean=0.1307,std=0.3081 are from the PyTorch MNIST example
            // https://github.com/pytorch/examples/blob/54f4572509891883a947411fd7239237dd2a39c3/mnist/main.py#L122
            .map(|tensor| ((tensor / 255) - 0.1307) / 0.3081)
            .collect();

        let targets = items
            .iter()
            .map(|item| Tensor::&lt;B, 1, Int&gt;::from_data(
                Data::from([(item.label as i64).elem()]),
                &amp;self.device
            ))
            .collect();

        let images = Tensor::cat(images, 0).to_device(&amp;self.device);
        let targets = Tensor::cat(targets, 0).to_device(&amp;self.device);

        MNISTBatch { images, targets }
    }
}</code></pre>
<details>
<summary><strong>ðŸ¦€ Iterators and Closures</strong></summary>
<p>The iterator pattern allows you to perform some tasks on a sequence of items in turn.</p>
<p>In this example, an iterator is created over the <code>MNISTItem</code>s in the vector <code>items</code> by calling the
<code>iter</code> method.</p>
<p><em>Iterator adaptors</em> are methods defined on the <code>Iterator</code> trait that produce different iterators by
changing some aspect of the original iterator. Here, the <code>map</code> method is called in a chain to
transform the original data before consuming the final iterator with <code>collect</code> to obtain the
<code>images</code> and <code>targets</code> vectors. Both vectors are then concatenated into a single tensor for the
current batch.</p>
<p>You probably noticed that each call to <code>map</code> is different, as it defines a function to execute on
the iterator items at each step. These anonymous functions are called
<a href="https://doc.rust-lang.org/book/ch13-01-closures.html"><em>closures</em></a> in Rust. They're easy to
recognize due to their syntax which uses vertical bars <code>||</code>. The vertical bars capture the input
variables (if applicable) while the rest of the expression defines the function to execute.</p>
<p>If we go back to the example, we can break down and comment the expression used to process the
images.</p>
<pre><code class="language-rust  ignore">let images = items                                                       // take items Vec&lt;MNISTItem&gt;
    .iter()                                                              // create an iterator over it
    .map(|item| Data::&lt;f32, 2&gt;::from(item.image))                        // for each item, convert the image to float32 data struct
    .map(|data| Tensor::&lt;B, 2&gt;::from_data(data.convert(), &amp;self.device)) // for each data struct, create a tensor on the device
    .map(|tensor| tensor.reshape([1, 28, 28]))                           // for each tensor, reshape to the image dimensions [C, H, W]
    .map(|tensor| ((tensor / 255) - 0.1307) / 0.3081)                    // for each image tensor, apply normalization
    .collect();                                                          // consume the resulting iterator &amp; collect the values into a new vector</code></pre>
<p>For more information on iterators and closures, be sure to check out the
<a href="https://doc.rust-lang.org/book/ch13-00-functional-features.html">corresponding chapter</a> in the Rust
Book.</p>
</details><br>
<p>In the previous example, we implement the <code>Batcher</code> trait with a list of <code>MNISTItem</code> as input and a
single <code>MNISTBatch</code> as output. The batch contains the images in the form of a 3D tensor, along with
a targets tensor that contains the indexes of the correct digit class. The first step is to parse
the image array into a <code>Data</code> struct. Burn provides the <code>Data</code> struct to encapsulate tensor storage
information without being specific for a backend. When creating a tensor from data, we often need to
convert the data precision to the current backend in use. This can be done with the <code>.convert()</code>
method. While importing the <code>burn::tensor::ElementConversion</code> trait, you can call <code>.elem()</code> on a
specific number to convert it to the current backend element type in use.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../basic-workflow/model.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../basic-workflow/training.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../basic-workflow/model.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../basic-workflow/training.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
