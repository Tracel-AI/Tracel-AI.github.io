<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Autodiff - The Burn Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../motivation.html"><strong aria-hidden="true">2.</strong> Why Burn?</a></li><li class="chapter-item expanded "><a href="../basic-workflow/index.html"><strong aria-hidden="true">3.</strong> Basic Workflow: From Training to Inference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basic-workflow/model.html"><strong aria-hidden="true">3.1.</strong> Model</a></li><li class="chapter-item expanded "><a href="../basic-workflow/data.html"><strong aria-hidden="true">3.2.</strong> Data</a></li><li class="chapter-item expanded "><a href="../basic-workflow/training.html"><strong aria-hidden="true">3.3.</strong> Training</a></li><li class="chapter-item expanded "><a href="../basic-workflow/backend.html"><strong aria-hidden="true">3.4.</strong> Backend</a></li><li class="chapter-item expanded "><a href="../basic-workflow/inference.html"><strong aria-hidden="true">3.5.</strong> Inference</a></li><li class="chapter-item expanded "><a href="../basic-workflow/conclusion.html"><strong aria-hidden="true">3.6.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="../building-blocks/index.html"><strong aria-hidden="true">4.</strong> Building Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building-blocks/backend.html"><strong aria-hidden="true">4.1.</strong> Backend</a></li><li class="chapter-item expanded "><a href="../building-blocks/tensor.html"><strong aria-hidden="true">4.2.</strong> Tensor</a></li><li class="chapter-item expanded "><a href="../building-blocks/autodiff.html" class="active"><strong aria-hidden="true">4.3.</strong> Autodiff</a></li><li class="chapter-item expanded "><a href="../building-blocks/module.html"><strong aria-hidden="true">4.4.</strong> Module</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Import ONNX Model</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Advanced</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Custom Training Loops</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Custom Metric</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Custom Kernels</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.1.</strong> WGPU</div></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Burn Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="autodiff"><a class="header" href="#autodiff">Autodiff</a></h1>
<p>Burn's tensor also supports autodifferentiation, which is an essential part of any deep learning framework.
We introduced the <code>Backend</code> trait in the <a href="./backend.html">previous section</a>, but Burn also has another trait for autodiff: <code>ADBackend</code>.</p>
<p>However, not all tensors support auto-differentiation; you need a backend that implements both the <code>Backend</code> and <code>ADBackend</code> traits.
Fortunately, you can add autodifferentiation capabilities to any backend using a backend decorator: <code>type MyAutodiffBackend = ADBackendDecorator&lt;MyBackend&gt;</code>.
This decorator implements both the <code>ADBackend</code> and <code>Backend</code> traits by maintaining a dynamic computational graph and utilizing the inner backend to execute tensor operations.</p>
<p>The <code>ADBackend</code> trait adds new operations on float tensors that can't be called otherwise.
It also provides a new associated type, <code>B::Gradients</code>, where each calculated gradient resides.</p>
<pre><code class="language-rust  ignore">fn calculate_gradients&lt;B: ADBackend&gt;(tensor: Tensor&lt;B, 2&gt;) -&gt; B::Gradients {
    let mut gradients = tensor.clone().backward();

    let tensor_grad = tensor.grad(&amp;gradients);        // get
    let tensor_grad = tensor.grad_remove(&amp;mut gradients); // pop

    gradients
}</code></pre>
<p>Note that some functions will always be available even if the backend doesn't implement the <code>ADBackend</code> trait.
In such cases, those functions will do nothing.</p>
<div class="table-wrapper"><table><thead><tr><th>Burn API</th><th>PyTorch Equivalent</th></tr></thead><tbody>
<tr><td><code>tensor.detach()</code></td><td><code>tensor.detach()</code></td></tr>
<tr><td><code>tensor.require_grad()</code></td><td><code>tensor.requires_grad()</code></td></tr>
<tr><td><code>tensor.is_require_grad()</code></td><td><code>tensor.requires_grad</code></td></tr>
<tr><td><code>tensor.set_require_grad(require_grad)</code></td><td><code>tensor.requires_grad(False)</code></td></tr>
</tbody></table>
</div>
<p>However, you're unlikely to make any mistakes since you can't call <code>backward</code> on a tensor that is on a backend that doesn't implement <code>ADBackend</code>.
Additionally, you can't retrieve the gradient of a tensor without an autodiff backend.</p>
<h2 id="difference-with-pytorch"><a class="header" href="#difference-with-pytorch">Difference with PyTorch</a></h2>
<p>The way Burn handles gradients is different from PyTorch.
First, when calling <code>backward</code>, each parameter doesn't have its <code>grad</code> field updated.
Instead, the backward pass returns all the calculated gradients in a container.
This approach offers numerous benefits, such as the ability to easily send gradients to other threads.</p>
<p>You can also retrieve the gradient for a specific parameter using the <code>grad</code> method on a tensor.
Since this method takes the gradients as input, it's hard to forget to call <code>backward</code> beforehand.
Note that sometimes, using <code>grad_remove</code> can improve performance by allowing inplace operations.</p>
<p>In PyTorch, when you don't need gradients for inference or validation, you typically need to scope your code using a block.</p>
<pre><code class="language-python"># Inference mode
torch.inference():
   # your code
   ...

# Or no grad
torch.no_grad():
   # your code
   ...
</code></pre>
<p>With Burn, you don't need to wrap the backend with the <code>ADBackendDecorator</code> for inference, and you can call <code>inner()</code> to obtain the inner tensor, which is useful for validation.</p>
<pre><code class="language-rust  ignore">/// Use `B: ADBackend`
fn example_validation&lt;B: ADBackend&gt;(tensor: Tensor&lt;B, 2&gt;) {
    let inner_tensor: Tensor&lt;B::InnerBackend, 2&gt; = tensor.inner();
    let _ = inner_tensor + 5;
}

/// Use `B: Backend`
fn example_inference&lt;B: Backend&gt;(tensor: Tensor&lt;B, 2&gt;) {
    let _ = tensor + 5;
    ...
}</code></pre>
<p><strong>Gradients with Optimizers</strong></p>
<p>We've seen how gradients can be used with tensors, but the process is a bit different when working with optimizers from <code>burn-core</code>.
To work with the <code>Module</code> trait, a translation step is required to link tensor parameters with their gradients.
This step is necessary to easily support gradient accumulation and training on multiple devices, where each module can be forked and run on different devices in parallel.
We'll explore deeper into this topic in the <a href="./module.html">Module</a> section.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../building-blocks/tensor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../building-blocks/module.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../building-blocks/tensor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../building-blocks/module.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
