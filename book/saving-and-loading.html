<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Saving &amp; Loading Models - The Burn Book ðŸ”¥</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="motivation.html"><strong aria-hidden="true">2.</strong> Why Burn?</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">3.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="basic-workflow/index.html"><strong aria-hidden="true">4.</strong> Basic Workflow: From Training to Inference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="basic-workflow/model.html"><strong aria-hidden="true">4.1.</strong> Model</a></li><li class="chapter-item expanded "><a href="basic-workflow/data.html"><strong aria-hidden="true">4.2.</strong> Data</a></li><li class="chapter-item expanded "><a href="basic-workflow/training.html"><strong aria-hidden="true">4.3.</strong> Training</a></li><li class="chapter-item expanded "><a href="basic-workflow/backend.html"><strong aria-hidden="true">4.4.</strong> Backend</a></li><li class="chapter-item expanded "><a href="basic-workflow/inference.html"><strong aria-hidden="true">4.5.</strong> Inference</a></li><li class="chapter-item expanded "><a href="basic-workflow/conclusion.html"><strong aria-hidden="true">4.6.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="building-blocks/index.html"><strong aria-hidden="true">5.</strong> Building Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="building-blocks/backend.html"><strong aria-hidden="true">5.1.</strong> Backend</a></li><li class="chapter-item expanded "><a href="building-blocks/tensor.html"><strong aria-hidden="true">5.2.</strong> Tensor</a></li><li class="chapter-item expanded "><a href="building-blocks/autodiff.html"><strong aria-hidden="true">5.3.</strong> Autodiff</a></li><li class="chapter-item expanded "><a href="building-blocks/module.html"><strong aria-hidden="true">5.4.</strong> Module</a></li><li class="chapter-item expanded "><a href="building-blocks/learner.html"><strong aria-hidden="true">5.5.</strong> Learner</a></li><li class="chapter-item expanded "><a href="building-blocks/metric.html"><strong aria-hidden="true">5.6.</strong> Metric</a></li><li class="chapter-item expanded "><a href="building-blocks/config.html"><strong aria-hidden="true">5.7.</strong> Config</a></li><li class="chapter-item expanded "><a href="building-blocks/record.html"><strong aria-hidden="true">5.8.</strong> Record</a></li><li class="chapter-item expanded "><a href="building-blocks/dataset.html"><strong aria-hidden="true">5.9.</strong> Dataset</a></li></ol></li><li class="chapter-item expanded "><a href="custom-training-loop.html"><strong aria-hidden="true">6.</strong> Custom Training Loop</a></li><li class="chapter-item expanded "><a href="saving-and-loading.html" class="active"><strong aria-hidden="true">7.</strong> Saving & Loading Models</a></li><li class="chapter-item expanded "><a href="import/index.html"><strong aria-hidden="true">8.</strong> Import Models</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="import/onnx-model.html"><strong aria-hidden="true">8.1.</strong> ONNX Model</a></li><li class="chapter-item expanded "><a href="import/pytorch-model.html"><strong aria-hidden="true">8.2.</strong> PyTorch Model</a></li></ol></li><li class="chapter-item expanded "><a href="advanced/index.html"><strong aria-hidden="true">9.</strong> Advanced</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="advanced/backend-extension/index.html"><strong aria-hidden="true">9.1.</strong> Backend Extension</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="advanced/backend-extension/custom-wgpu-kernel.html"><strong aria-hidden="true">9.1.1.</strong> Custom WGPU Kernel</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.2.</strong> Custom Optimizer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.3.</strong> WebAssembly</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.4.</strong> No-Std</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Burn Book ðŸ”¥</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="saving-and-loading-models"><a class="header" href="#saving-and-loading-models">Saving and Loading Models</a></h1>
<p>Saving your trained machine learning model is quite easy, no matter the output format you choose. As
mentioned in the <a href="./building-blocks/record.html">Record</a> section, different formats are supported to
serialize/deserialize models. By default, we use the <code>NamedMpkFileRecorder</code> which uses the
<a href="https://msgpack.org/">MessagePack</a> binary serialization format with the help of
<a href="https://docs.rs/rmp-serde/">smp_serde</a>.</p>
<pre><code class="language-rust  ignore">// Save model in MessagePack format with full precision
let recorder = NamedMpkFileRecorder::&lt;FullPrecisionSettings&gt;::new();
model
  .save_file(model_path, &amp;recorder)
  .expect(&quot;Should be able to save the model&quot;);</code></pre>
<p>Note that the file extension is automatically handled by the recorder depending on the one you
choose. Therefore, only the file path and base name should be provided.</p>
<p>Now that you have a trained model saved to your disk, you can easily load it in a similar fashion.</p>
<pre><code class="language-rust  ignore">// Load model in full precision from MessagePack file
let recorder = NamedMpkFileRecorder::&lt;FullPrecisionSettings&gt;::new();
model
  .load_file(model_path, &amp;recorder, device)
  .expect(&quot;Should be able to load the model weights from the provided file&quot;);</code></pre>
<p><strong>Note:</strong> models can be saved in different output formats, just make sure you are using the correct
recorder type when loading the saved model. Type conversion between different precision settings is
automatically handled, but formats are not interchangeable. A model can be loaded from one format
and saved to another format, just as long as you load it back with the new recorder type afterwards.</p>
<h2 id="initialization-from-recorded-weights"><a class="header" href="#initialization-from-recorded-weights">Initialization from Recorded Weights</a></h2>
<p>While the first approach is very straightforward, it does require the model to already be
initialized. If instead you would like to skip the initialization and directly load the weights into
the modules of your model, you can create a new initialization function. Let's take the following
model definition as a simple example.</p>
<pre><code class="language-rust  ignore">#[derive(Module, Debug)]
pub struct Model&lt;B: Backend&gt; {
    linear_in: Linear&lt;B&gt;,
    linear_out: Linear&lt;B&gt;,
    activation: ReLU,
}</code></pre>
<p>Similar to the <a href="../basic-workflow/inference.html">basic workflow inference example</a>, we can define a
new initialization function which initializes the different parts of our model with the record
values.</p>
<pre><code class="language-rust  ignore">impl&lt;B: Backend&gt; Model&lt;B&gt; {
    /// Returns the initialized model using the recorded weights.
    pub fn init_with(record: ModelRecord&lt;B&gt;) -&gt; Model&lt;B&gt; {
        Model {
            linear_in: LinearConfig::new(10, 64).init_with(record.linear_in),
            linear_out: LinearConfig::new(64, 2).init_with(record.linear_out),
            activation: ReLU::new(),
        }
    }

    /// Returns the dummy model with randomly initialized weights.
    pub fn new(device: &amp;Device&lt;B&gt;) -&gt; Model&lt;B&gt; {
        let l1 = LinearConfig::new(10, 64).init(device);
        let l2 = LinearConfig::new(64, 2).init(device);
        Model {
            linear_in: l1,
            linear_out: l2,
            activation: ReLU::new(),
        }
    }
}</code></pre>
<p>Now, let's save a model that we can load later. In the following snippets, we use
<code>type MyBackend = NdArray&lt;f32&gt;</code> but you can use whatever backend you like.</p>
<pre><code class="language-rust  ignore">// Create a dummy initialized model to save
let device = Default::default();
let model = Model::&lt;MyBackend&gt;::new(&amp;device);

// Save model in MessagePack format with full precision
let recorder = NamedMpkFileRecorder::&lt;FullPrecisionSettings&gt;::new();
model
    .save_file(model_path, &amp;recorder)
    .expect(&quot;Should be able to save the model&quot;);</code></pre>
<p>Afterwards, the model can just as easily be loaded from the record saved on disk.</p>
<pre><code class="language-rust  ignore">// Load model record on the backend's default device
let record: ModelRecord&lt;MyBackend&gt; = NamedMpkFileRecorder::&lt;FullPrecisionSettings&gt;::new()
    .load(model_path.into(), device)
    .expect(&quot;Should be able to load the model weights from the provided file&quot;);

// Directly initialize a new model with the loaded record/weights
let model = Model::init_with(record);</code></pre>
<h2 id="no-storage-no-problem"><a class="header" href="#no-storage-no-problem">No Storage, No Problem!</a></h2>
<p>For applications where file storage may not be available (or desired) at runtime, you can use the
<code>BinBytesRecorder</code>.</p>
<p>In the previous examples we used a <code>FileRecorder</code> based on the MessagePack format, which could be
replaced with <a href="./building-blocks/record.html#recorder">another file recorder</a> of your choice. To embed
a model as part of your runtime application, first save the model to a binary file with
<code>BinFileRecorder</code>.</p>
<pre><code class="language-rust  ignore">// Save model in binary format with full precision
let recorder = BinFileRecorder::&lt;FullPrecisionSettings&gt;::new();
model
  .save_file(model_path, &amp;recorder)
  .expect(&quot;Should be able to save the model&quot;);</code></pre>
<p>Then, in your final application, include the model and use the <code>BinBytesRecorder</code> to load it.</p>
<p>Embedding the model as part of your application is especially useful for smaller models but not
recommended for very large models as it would significantly increase the binary size as well as
consume a lot more memory at runtime.</p>
<pre><code class="language-rust  ignore">// Include the model file as a reference to a byte array
static MODEL_BYTES: &amp;[u8] = include_bytes!(&quot;path/to/model.bin&quot;);

// Load model binary record in full precision
let record = BinBytesRecorder::&lt;FullPrecisionSettings&gt;::default()
    .load(MODEL_BYTES.to_vec(), device)
    .expect(&quot;Should be able to load model the model weights from bytes&quot;);

// Load that record with the model
model.load_record(record);</code></pre>
<p>This example assumes that the model was already created before loading the model record. If instead
you want to skip the random initialization and directly initialize the weights with the provided
record, you could adapt this like the <a href="#initialization-from-recorded-weights">previous example</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="custom-training-loop.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="import/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="custom-training-loop.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="import/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
